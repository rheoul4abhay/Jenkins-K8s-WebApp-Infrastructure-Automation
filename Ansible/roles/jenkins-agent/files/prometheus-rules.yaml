apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: myapp-alerts
  namespace: monitoring
  labels:
    myapp-alerts: "true"
    release: kube-prometheus-stack
spec:
  groups:
    - name: myapp.rules
      rules:
        - alert: MyAppPendingPods
          expr: "count(kube_pod_status_phase{namespace=\"production\", phase=~\"Pending|Failed\", pod=~\"myapp-.*\"} * on(pod) (time() - kube_pod_start_time_seconds{namespace=\"production\", pod=~\"myapp-.*\"} < 600)) >= 3"
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "MyApp has 3 or more pending or failing pods"
            description: "Pods in Pending/Failed state for more than 2 minutes: {{ $labels.pod }}"

        - alert: ImagePullBackOffDetected
          expr: "kube_pod_container_status_waiting_reason{namespace=\"production\", reason=\"ImagePullBackOff\", pod=~\"myapp-.*\"} > 0"
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "ImagePullBackOff in Pod {{ $labels.pod }}"
            description: "Pod {{ $labels.pod }} is in ImagePullBackOff state. Check image name, tag, and registry access."

        - alert: CrashLoopBackOffDetected
          expr: "increase(kube_pod_container_status_restarts_total{namespace=\"production\", pod=~\"myapp-.*\"}[5m]) > 3"
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "CrashLoopBackOff in Pod {{ $labels.pod }}"
            description: "Pod {{ $labels.pod }} is restarting frequently (CrashLoopBackOff). Investigate logs and health checks."

        - alert: PodCPUHighUsage
          expr: "sum(rate(container_cpu_usage_seconds_total{namespace=\"production\", pod=~\"myapp-.*\"}[5m])) by (pod) > 0.8 * 0.15"
          for: 30s
          labels:
            severity: warning
          annotations:
            summary: "High CPU Usage in Pod {{ $labels.pod }}"
            description: "Pod {{ $labels.pod }} is using more than 80% of its CPU limit"

        - alert: PodMemoryHighUsage
          expr: "sum(container_memory_usage_bytes{namespace=\"production\", pod=~\"myapp-.*\"}) by (pod) > 0.8 * 268435456"
          for: 30s
          labels:
            severity: warning
          annotations:
            summary: "High Memory Usage in Pod {{ $labels.pod }}"
            description: "Pod {{ $labels.pod }} is using more than 80% of its Memory limit"
